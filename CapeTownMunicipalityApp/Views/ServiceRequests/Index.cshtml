@using System.Text.Json
@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@model IEnumerable<CapeTownMunicipalityApp.Models.Report>
@{
    ViewData["Title"] = "Services";

    string PriorityLabel(int priority)
    {
        // Normalize priority to valid range (1-3)
        var normalizedPriority = priority switch
        {
            <= 1 => 1,
            >= 3 => 3,
            _ => priority
        };
        
        return normalizedPriority switch
        {
            1 => "High",
            2 => "Medium",
            3 => "Low",
            _ => "Medium"
        };
    }

    string PriorityColorClass(int priority)
    {
        // Normalize priority to valid range (1-3)
        var normalizedPriority = priority switch
        {
            <= 1 => 1,
            >= 3 => 3,
            _ => priority
        };
        
        return normalizedPriority switch
        {
            1 => "priority-high",
            2 => "priority-medium",
            3 => "priority-low",
            _ => "priority-medium"
        };
    }
    
    int NormalizePriority(int priority) => priority switch
    {
        <= 1 => 1,
        >= 3 => 3,
        _ => priority
    };

    string StatusBadge(CapeTownMunicipalityApp.Models.ReportStatus status) => status switch
    {
        CapeTownMunicipalityApp.Models.ReportStatus.Pending => "status-pending",
        CapeTownMunicipalityApp.Models.ReportStatus.Resolved => "status-resolved",
        CapeTownMunicipalityApp.Models.ReportStatus.Closed => "status-closed",
        _ => "status-pending"
    };

    var jsonOptions = new JsonSerializerOptions
    {
        Encoder = JavaScriptEncoder.UnsafeRelaxedJsonEscaping
    };
}

<style>
    .filter-container {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .filter-row {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: end;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        min-width: 150px;
        flex: 1;
    }

    .filter-group label {
        font-weight: 600;
        margin-bottom: 5px;
        color: #495057;
    }

    .filter-group input {
        padding: 8px 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
    }

    .filter-group input:focus {
        outline: none;
        border-color: #B0C434;
        box-shadow: 0 0 0 2px rgba(176,196,52,0.25);
    }

    .btn-filter {
        background: #B0C434;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        height: fit-content;
    }

    .btn-filter:hover {
        background: #9fb02d;
    }

    .services-list {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .service-row {
        display: grid;
        grid-template-columns: 150px 120px 1fr 120px 160px 140px;
        gap: 15px;
        padding: 15px 20px;
        border-bottom: 1px solid #e9ecef;
        transition: background 0.2s;
        align-items: center;
    }

    .service-row:hover {
        background: #f8f9fa;
    }

    .service-row > div:not(.priority-container) {
        cursor: pointer;
    }

    .service-row:last-child {
        border-bottom: none;
    }

    .tracking-code {
        font-weight: 600;
        color: #B0C434;
        letter-spacing: 0.5px;
    }

    .status-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: inline-block;
    }

    .status-badge.status-pending { background: rgba(176, 196, 52, 0.2); color: #4a5a1a; }
    .status-badge.status-resolved { background: rgba(102, 187, 106, 0.2); color: #1b5e20; }
    .status-badge.status-closed { background: rgba(96, 125, 139, 0.2); color: #263238; }

    .location-text {
        color: #495057;
        font-weight: 500;
    }

    .category-text {
        color: #6c757d;
        font-size: 14px;
    }

    .priority-container {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .priority-tag {
        padding: 4px 10px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 12px;
        display: inline-block;
        min-width: 60px;
        text-align: center;
    }

    .priority-tag.priority-high {
        background: rgba(239, 68, 68, 0.2);
        color: #991b1b;
    }

    .priority-tag.priority-medium {
        background: rgba(249, 115, 22, 0.2);
        color: #9a3412;
    }

    .priority-tag.priority-low {
        background: rgba(34, 197, 94, 0.2);
        color: #166534;
    }

    .priority-btn {
        background: #B0C434;
        color: white;
        border: none;
        border-radius: 4px;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        transition: background 0.2s;
        padding: 0;
    }

    .priority-btn:hover {
        background: #9fb02d;
    }

    .priority-btn:disabled {
        background: #d1d5db;
        cursor: not-allowed;
        opacity: 0.5;
    }

    .date-text {
        color: #6c757d;
        font-size: 13px;
    }

    .list-header {
        display: grid;
        grid-template-columns: 150px 120px 1fr 120px 160px 140px;
        gap: 15px;
        padding: 12px 20px;
        background: #f8f9fa;
        border-bottom: 2px solid #B0C434;
        font-weight: 600;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #495057;
    }

    .services-empty {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 0;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .modal-header {
        background: linear-gradient(135deg, #B0C434 0%, #9fb02d 100%);
        color: white;
        padding: 20px;
        border-radius: 8px 8px 0 0;
        position: relative;
    }

    .modal-title {
        font-size: 20px;
        font-weight: 600;
        margin: 0;
        padding-right: 40px;
    }

    .close {
        position: absolute;
        right: 20px;
        top: 20px;
        color: white;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.2s;
    }

    .close:hover {
        background: rgba(255,255,255,0.2);
    }

    .modal-body {
        padding: 20px;
    }

    .modal-description {
        font-size: 16px;
        line-height: 1.6;
        color: #495057;
        background: #f8f9fa;
        padding: 16px;
        border-radius: 6px;
        margin-bottom: 0;
    }

    .modal-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    .modal-detail-item {
        display: flex;
        flex-direction: column;
    }

    .modal-detail-label {
        font-weight: 600;
        color: #6c757d;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 5px;
    }

    .modal-detail-value {
        color: #495057;
        font-size: 14px;
    }

    .attachments-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .attachments-list li {
        padding: 10px;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        margin-bottom: 8px;
    }

    .attachments-list li a {
        color: #B0C434;
        text-decoration: none;
        font-weight: 500;
    }

    .attachments-list li a:hover {
        text-decoration: underline;
    }

    @@media (max-width: 768px) {
        .service-row,
        .list-header {
            grid-template-columns: 1fr;
            gap: 8px;
        }

        .list-header {
            display: none;
        }

        .filter-row {
            flex-direction: column;
            align-items: stretch;
        }

        .filter-group {
            min-width: auto;
        }

        .modal-details {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="container-fluid">
    <h1 class="mb-4 text-center">@Localizer["Services"]</h1>
    
    <div class="filter-container">
        <form method="get" action="@Url.Action("Index")">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="q">Search</label>
                    <input type="text" name="q" id="q" value="@Context.Request.Query["q"]" placeholder="Search by tracking code, location, or description" />
        </div>
                <button type="submit" class="btn-filter">Filter</button>
        </div>
    </form>
    </div>

    @if (Model != null && Model.Any())
    {
        <div class="services-list">
            <div class="list-header">
                <div>Tracking Code</div>
                <div>Status</div>
                <div>Location</div>
                <div>Category</div>
                <div>Priority</div>
                <div>Created</div>
            </div>
            @foreach (var r in Model)
            {
                var normalizedPriority = NormalizePriority(r.Priority);
                var payload = new
                {
                    trackingCode = r.TrackingCode,
                    category = r.Category.ToString(),
                    location = r.Location,
                    status = r.Status.ToString(),
                    priority = PriorityLabel(r.Priority),
                    priorityValue = normalizedPriority,
                    priorityColorClass = PriorityColorClass(r.Priority),
                    statusBadgeClass = StatusBadge(r.Status),
                    createdAt = r.CreatedAt.ToLocalTime().ToString("f"),
                    updatedAt = r.UpdatedAt?.ToLocalTime().ToString("f") ?? "Pending update",
                    description = string.IsNullOrWhiteSpace(r.Description) ? "No description provided." : r.Description,
                    attachments = (r.Attatchments ?? new List<CapeTownMunicipalityApp.Models.ReportAttatchment>())
                        .Select(a => new { a.FileName, a.FilePath })
                };

                var jsonPayload = JsonSerializer.Serialize(payload, jsonOptions);

                <div class="service-row" data-request='@Html.Raw(jsonPayload)'>
                    <div class="tracking-code" onclick="openRequestModal(this.closest('.service-row'))">@r.TrackingCode</div>
                    <div onclick="openRequestModal(this.closest('.service-row'))"><span class="status-badge @StatusBadge(r.Status)">@r.Status</span></div>
                    <div class="location-text" onclick="openRequestModal(this.closest('.service-row'))">@r.Location</div>
                    <div class="category-text" onclick="openRequestModal(this.closest('.service-row'))">@r.Category</div>
                    <div class="priority-container">
                        @{
                            var normPriority = NormalizePriority(r.Priority);
                        }
                        <button class="priority-btn" onclick="event.stopPropagation(); updatePriority('@r.TrackingCode', true)" 
                                @(normPriority == 1 ? "disabled" : "") title="Increase Priority">↑</button>
                        <span class="priority-tag @PriorityColorClass(r.Priority)" data-priority="@normPriority">@PriorityLabel(r.Priority)</span>
                        <button class="priority-btn" onclick="event.stopPropagation(); updatePriority('@r.TrackingCode', false)" 
                                @(normPriority == 3 ? "disabled" : "") title="Decrease Priority">↓</button>
                    </div>
                    <div class="date-text" onclick="openRequestModal(this.closest('.service-row'))">@r.CreatedAt.ToLocalTime().ToString("g")</div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="services-empty">
            <p>No service requests found matching your criteria.</p>
        </div>
    }
</div>

<div id="requestModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="requestModalTitle">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="requestModalTitle"></h2>
            <span class="close" onclick="closeRequestModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="modal-details">
                <div class="modal-detail-item">
                    <div class="modal-detail-label">Category</div>
                    <div class="modal-detail-value" id="requestCategory"></div>
                </div>
                <div class="modal-detail-item">
                    <div class="modal-detail-label">Priority</div>
                    <div class="modal-detail-value" id="requestPriority"></div>
                </div>
                <div class="modal-detail-item">
                    <div class="modal-detail-label">Status</div>
                    <div class="modal-detail-value" id="requestStatus"></div>
                </div>
                <div class="modal-detail-item">
                    <div class="modal-detail-label">Location</div>
                    <div class="modal-detail-value" id="requestLocation"></div>
                </div>
                <div class="modal-detail-item">
                    <div class="modal-detail-label">Created</div>
                    <div class="modal-detail-value" id="requestCreated"></div>
                </div>
                <div class="modal-detail-item">
                    <div class="modal-detail-label">Last Updated</div>
                    <div class="modal-detail-value" id="requestUpdated"></div>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <div class="modal-detail-label" style="margin-bottom: 10px;">Description</div>
                <div class="modal-description" id="requestDescription"></div>
            </div>

            <div>
                <div class="modal-detail-label" style="margin-bottom: 10px;">Attachments</div>
                <ul class="attachments-list" id="requestAttachments"></ul>
            </div>
        </div>
    </div>
</div>

<script>
    const requestModal = document.getElementById('requestModal');
    const modalTitle = document.getElementById('requestModalTitle');
    const categoryField = document.getElementById('requestCategory');
    const priorityField = document.getElementById('requestPriority');
    const statusField = document.getElementById('requestStatus');
    const updatedField = document.getElementById('requestUpdated');
    const createdField = document.getElementById('requestCreated');
    const locationField = document.getElementById('requestLocation');
    const descriptionField = document.getElementById('requestDescription');
    const attachmentsList = document.getElementById('requestAttachments');

    document.querySelectorAll('.service-row > div:not(.priority-container)').forEach(cell => {
        cell.addEventListener('click', function() {
            openRequestModal(this.closest('.service-row'));
        });
    });

    function openRequestModal(row) {
        const data = JSON.parse(row.dataset.request);

        modalTitle.textContent = data.trackingCode;
        categoryField.textContent = data.category;
        
        // Update priority with color
        priorityField.innerHTML = `<span class="priority-tag ${data.priorityColorClass}">${data.priority}</span>`;
        
        // Update status with badge
        statusField.innerHTML = `<span class="status-badge ${data.statusBadgeClass}">${data.status}</span>`;
        
        createdField.textContent = data.createdAt;
        updatedField.textContent = data.updatedAt;
        locationField.textContent = data.location;
        descriptionField.textContent = data.description;

        attachmentsList.innerHTML = '';
        if (data.attachments && data.attachments.length > 0) {
            data.attachments.forEach(att => {
                const li = document.createElement('li');
                const link = document.createElement('a');
                link.href = att.filePath;
                link.textContent = att.fileName || 'Attachment';
                link.setAttribute('target', '_blank');
                link.setAttribute('rel', 'noopener');
                li.appendChild(link);
                attachmentsList.appendChild(li);
            });
        } else {
            const li = document.createElement('li');
            li.textContent = 'No attachments provided.';
            li.style.color = '#6c757d';
            attachmentsList.appendChild(li);
        }

        requestModal.style.display = 'block';
        document.body.style.overflow = 'hidden';
    }

    function closeRequestModal() {
        requestModal.style.display = 'none';
        document.body.style.overflow = '';
    }

    window.addEventListener('click', function (event) {
        if (event.target === requestModal) {
            closeRequestModal();
        }
    });

    window.addEventListener('keydown', function (event) {
        if (event.key === 'Escape' && requestModal.style.display === 'block') {
            closeRequestModal();
        }
    });

    async function updatePriority(trackingCode, increase) {
        try {
            const response = await fetch('@Url.Action("UpdatePriority", "ServiceRequests")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `trackingCode=${encodeURIComponent(trackingCode)}&increase=${increase}`
            });

            const result = await response.json();
            if (result.success) {
                location.reload();
            } else {
                alert('Unable to update priority: ' + (result.message || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error updating priority:', error);
            alert('An error occurred while updating priority.');
        }
    }
</script>
